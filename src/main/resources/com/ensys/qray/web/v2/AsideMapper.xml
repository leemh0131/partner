<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ensys.qray.web.v2.AsideMapper">

	<select id="liveComments" resultType="hashmap" parameterType="hashmap">
		/*AsideMapper.liveComments*/
		SELECT    A.DM_CD AS "DM_CD"
			 , COALESCE(SUBSTRING(B.DM_CONTENTS, 1, 12), B.COMP_NM) AS "COMP_NM" -- 피해내용 OR 사채쉑
			 , SUBSTRING(A.CONTENTS, 1, 12) AS "COMMENT"
			 , B.DM_TYPE AS "DM_TYPE"
			 , SUBSTRING(F_ES_CODE_DETAIL(#{COMPANY_CD}, 'ES_Q0139', B.DM_TYPE), 1, 2) AS "DM_TYPE_NM"
		FROM PL_DM_COMM A
		INNER JOIN PL_DM_M B
			ON A.DM_CD = B.DM_CD
		ORDER BY A.WRITE_DATE DESC
		LIMIT 5
	</select>

	<select id="liveRanks" resultType="hashmap" parameterType="hashmap">
		/*AsideMapper.liveRanks*/
		WITH TODAY_DATA AS ( --오늘 기준 최근 7일간 가장 인기많은 쉑
		SELECT
			  COUNT(A.DM_CD) AS DM_COUNT
			, B.DM_CD
			, COALESCE(SUBSTRING(B.COMP_NM, 1, 12), B.DM_CONTENTS) AS COMP_NM
			, B.DM_TYPE
			, B.WRITE_DATE
			, RANK() OVER (ORDER BY COUNT(A.DM_CD) DESC) AS TODAY_RANK
		FROM PL_DM_COMM A
		INNER JOIN PL_DM_M B
			ON A.DM_CD = B.DM_CD
		LEFT JOIN (
			SELECT SYSDEF_CD
			FROM ES_CODEDTL
			WHERE FIELD_CD = 'ES_Q0141'
		  AND FLAG1_CD = 'Y'
			LIMIT 1
		) D ON 1 = 1
		WHERE CURRENT_DATE - TO_DATE(SUBSTRING(REPLACE(B.WRITE_DATE, '-', ''), 1, 8), 'YYYYMMDD')<![CDATA[ < ]]> COALESCE(D.SYSDEF_CD::INTEGER, 7)
			GROUP BY B.DM_CD, B.COMP_NM, B.DM_CONTENTS, B.DM_TYPE, B.WRITE_DATE
		),
		YESTERDAY_DATA AS ( -- 어제 기준 최근 7일간 가장 인기많은 쉑
		SELECT
			  COUNT(A.DM_CD) AS DM_COUNT
			, B.DM_CD
			, RANK() OVER (ORDER BY COUNT(A.DM_CD) DESC) AS YESTERDAY_RANK
		FROM PL_DM_COMM A
		INNER JOIN PL_DM_M B
			ON A.DM_CD = B.DM_CD
		LEFT JOIN (
			SELECT SYSDEF_CD
			FROM ES_CODEDTL
			WHERE FIELD_CD = 'ES_Q0141'
		  AND FLAG1_CD = 'Y'
			LIMIT 1
		) D ON 1 = 1
		WHERE (CURRENT_DATE - 1) - TO_DATE(SUBSTRING(REPLACE(B.WRITE_DATE, '-', ''), 1, 8), 'YYYYMMDD')<![CDATA[ < ]]> COALESCE(D.SYSDEF_CD::INTEGER, 7)
			GROUP BY B.DM_CD
		)
		SELECT
			  T.DM_CD							AS "DM_CD"
			, T.DM_COUNT						AS "DM_COUNT"
			, T.COMP_NM							AS "COMP_NM"
			, T.DM_TYPE							AS "DM_TYPE"
			, T.WRITE_DATE						AS "WRITE_DATE"
			, T.TODAY_RANK						AS "TODAY_RANK"
			, Y.YESTERDAY_RANK					AS "YESTERDAY_RANK"
			, (Y.YESTERDAY_RANK - T.TODAY_RANK) AS "RANK_DIFF"   -- +면 상승, -면 하락
		FROM TODAY_DATA T
		LEFT JOIN YESTERDAY_DATA Y ON T.DM_CD = Y.DM_CD
		ORDER BY T.TODAY_RANK, T.WRITE_DATE DESC
		LIMIT 5
	</select>

	<select id="commonHeader" resultType="hashmap" parameterType="hashmap">
		/*AsideMapper.commonHeader*/
		SELECT A.FIELD_CD as "FIELD_CD"
			 , A.SYSDEF_CD as "SYSDEF_CD"
			 , A.COMPANY_CD as "COMPANY_CD"
			 , A.SYSCODE_FG1 as "SYSCODE_FG1"
			 , A.USRDEF_CD as "USRDEF_CD"
			 , A.USRDEF_NM as "USRDEF_NM"
			 , A.SYSDEF_NM as "SYSDEF_NM"
			 , A.USE_YN as "USE_YN"
			 , A.FLAG1_CD as "FLAG1_CD"
			 , A.FLAG2_CD as "FLAG2_CD"
			 , A.FLAG3_CD as "FLAG3_CD"
			 , A.SYSDEF_E_NM as "SYSDEF_E_NM"
			 , A.FLAG4_CD as "FLAG4_CD"
		FROM ES_CODEDTL A
		WHERE A.COMPANY_CD  = #{COMPANY_CD}
        AND A.FIELD_CD  = 'ES_Q0145'
        AND A.USE_YN = 'Y'
        ORDER BY A.FLAG4_CD
    </select>

</mapper>