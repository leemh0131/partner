<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ensys.qray.web.v2.dm.V2DmMapper">

    <select id="listCount" resultType="int" parameterType="hashmap">
        /*V2DmMapper.listCount*/
        SELECT COUNT(*)
        FROM PL_DM_M
        WHERE 1 = 1
        <if test='KEYWORD != null and KEYWORD != ""'>
            AND    (
                COMP_NM    LIKE  '%' || #{KEYWORD} || '%'
                OR BORW_SITE    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_TEL    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_KAKAO    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_TELE    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_TELE    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_TELE    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_SNS    LIKE  '%' || #{KEYWORD} || '%'
                OR WITHDR_LOCA    LIKE  '%' || #{KEYWORD} || '%'
                OR COMPL_POLICE    LIKE  '%' || #{KEYWORD} || '%'
                OR DM_CONTENTS    LIKE  '%' || #{KEYWORD} || '%'
            )
        </if>
    </select>

    <select id="list" resultType="hashmap" parameterType="hashmap">
        /*V2DmMapper.list*/
        SELECT    DM_CD AS "DM_CD"
                , F_NVL_TEXT(SUBSTRING(DM_CONTENTS, 1, 50), COMP_NM) AS "TITLE"
                , ROW_NUMBER() OVER (ORDER BY INSERT_DATE) AS "COMM_NUM"
                , F_NVL_TEXT(SUBSTRING(COMP_NM, 1, 3), '무명') AS "NAME"
                , TO_CHAR(SUBSTRING(INSERT_DATE, 1, 8)::DATE, 'YYYY-MM-DD HH:DD') AS "DTS"
                , (SELECT COUNT(*) FROM PL_DM_COMM WHERE DM_CD = A.DM_CD) AS "COMM_CUT"
                , CASE WHEN coalesce(HIT, 0) BETWEEN 0 AND 999 THEN coalesce(HIT, 0)::VARCHAR ELSE '999↑' END AS "HIT"
                , CASE WHEN CURRENT_DATE - TO_DATE(SUBSTRING(REPLACE(INSERT_DATE, '-', ''), 1, 8), 'YYYYMMDD') > F_NVL_NUM(B.SYSDEF_CD::INTEGER, 7) THEN 'N' ELSE 'Y' END AS "NEW_VALUE"
        FROM PL_DM_M A
        LEFT JOIN (SELECT SYSDEF_CD FROM ES_CODEDTL WHERE FIELD_CD = 'ES_Q0141' AND FLAG1_CD = 'Y' LIMIT 1) B
            ON 1 = 1
        WHERE 1 = 1
        <if test='KEYWORD != null and KEYWORD != ""'>
            AND    (
                COMP_NM    LIKE  '%' || #{KEYWORD} || '%'
                OR BORW_SITE    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_TEL    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_KAKAO    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_TELE    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_TELE    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_TELE    LIKE  '%' || #{KEYWORD} || '%'
                OR DEBTOR_SNS    LIKE  '%' || #{KEYWORD} || '%'
                OR WITHDR_LOCA    LIKE  '%' || #{KEYWORD} || '%'
                OR COMPL_POLICE    LIKE  '%' || #{KEYWORD} || '%'
                OR DM_CONTENTS    LIKE  '%' || #{KEYWORD} || '%'
            )
        </if>
        ORDER BY INSERT_DATE DESC
        LIMIT 15 OFFSET (#{CURRENT_PAGE}::INTEGER - 1) * 15
    </select>

    <insert id="create" parameterType="hashmap">
        /*V2DmMapper.create*/
        INSERT INTO PL_DM_M (
              DM_CD
            , DM_TYPE
            , DM_KIND
            , COMP_NM
            , BORW_SITE
            , DEBTOR_TEL
            , DEBTOR_KAKAO
            , DEBTOR_TELE
            , DEBTOR_SNS
            , WITHDR_LOCA
            , COMPL_POLICE
            , DM_CONTENTS
            , PW
            , USE_YN
            , WRITE_DATE
            , WRITE_IP
            , INSERT_DATE
            , UPDATE_DATE
        ) VALUES (
              #{DM_CD}
            , #{DM_TYPE}
            , #{DM_KIND}
            , #{COMP_NM}
            , #{BORW_SITE}
            , #{DEBTOR_TEL}
            , #{DEBTOR_KAKAO}
            , #{DEBTOR_TELE}
            , #{DEBTOR_SNS}
            , #{WITHDR_LOCA_ARR}
            , #{COMPL_POLICE}
            , #{DM_CONTENTS}
            , #{PW}
            , 'Y'
            , #{WRITE_DATE}
            , #{WRITE_IP}
            , #{INSERT_DATE}
            , #{UPDATE_DATE}
        )
    </insert>

    <delete id="delete" parameterType="hashmap">
        /*V2DmMapper.delete*/
        DELETE FROM PL_DM_M
        WHERE DM_CD = #{DM_CD}
    </delete>

    <insert id="createDeposit" parameterType="hashmap">
        /*V2DmMapper.createDeposit*/
        <if test="BANK_CD_ARR != null and BANK_CD_ARR != ''">
            <foreach item="bankCd" index="index" collection='BANK_CD_ARR.split("\\|")' separator=";">
                INSERT INTO PL_DM_DEPOSIT (
                      DM_CD
                    , SEQ
                    , BANK_CD
                    , NO_DEPOSIT
                    , NM_DEPOSITOR
                    , USE_YN
                    , INSERT_DATE
                    , UPDATE_DATE
                ) VALUES (
                      #{DM_CD}
                    , #{index} + 1
                    , SPLIT_PART(#{BANK_CD_ARR}, '|', #{index} + 1) -- BANK_CD
                    , SPLIT_PART(#{NO_DEPOSIT_ARR}, '|', #{index} + 1) -- NO_DEPOSIT
                    , SPLIT_PART(#{NM_DEPOSITOR_ARR}, '|', #{index} + 1) -- NM_DEPOSITOR
                    , 'Y'
                    , #{INSERT_DATE}
                    , #{UPDATE_DATE}
                )
            </foreach>
        </if>
    </insert>

    <select id="detail" resultType="hashmap" parameterType="hashmap">
        /*V2DmMapper.detail*/
        SELECT A.DM_CD AS "DM_CD"
             , A.COMP_NM AS "COMP_NM"
             , F_ES_CODE_DETAIL('1000', 'ES_Q0139', A.DM_TYPE)              AS "DM_TYPE"
             , A.DM_TYPE              AS "DM_TYPE_CD"
             , CASE WHEN A.DM_TYPE = '001' THEN NULL ELSE F_ES_CODE_DETAIL('1000', 'ES_Q0140', A.DM_KIND) END "DM_KIND"
             , TO_CHAR(SUBSTRING(A.WRITE_DATE, 1, 8)::DATE, 'YYYY-MM-DD HH:DD') AS "WRITE_DATE"
             , CASE WHEN coalesce(HIT, 0) BETWEEN 0 AND 999 THEN coalesce(HIT, 0)::VARCHAR ELSE '999↑' END AS "HIT"
             , A.BORW_SITE              AS "BORW_SITE"
             , F_NVL_TEXT(RPAD(LEFT(A.DEBTOR_TEL, GREATEST(LENGTH(A.DEBTOR_TEL) - 5, 0)), LENGTH(A.DEBTOR_TEL), '*'), '모름')             AS "DEBTOR_TEL"
             , A.DEBTOR_KAKAO           AS "DEBTOR_KAKAO"
             , A.DEBTOR_TELE            AS "DEBTOR_TELE"
             , A.DEBTOR_SNS             AS "DEBTOR_SNS"
             , A.WITHDR_LOCA            AS "WITHDR_LOCA"
             , A.DM_CONTENTS            AS "DM_CONTENTS"
             , A.COMPL_POLICE           AS "COMPL_POLICE"
        FROM PL_DM_M A
        WHERE A.DM_CD = #{DM_CD}
    </select>

    <select id="detailDeposit" resultType="hashmap" parameterType="hashmap">
        /*V2DmMapper.detailDeposit*/
        SELECT F_ES_CODE_DETAIL('1000', 'ES_Q0009', BANK_CD) || ' ' || RPAD(LEFT(NO_DEPOSIT, GREATEST(LENGTH(NO_DEPOSIT) - 5, 0)), LENGTH(NO_DEPOSIT), '*') || ' (' || NM_DEPOSITOR || ')' AS "DEPOSIT"
        FROM PL_DM_DEPOSIT
        WHERE DM_CD = #{DM_CD}
    </select>

    <select id="relationList" resultType="hashmap" parameterType="hashmap">
        /*V2DmMapper.relationList*/
        SELECT    A.DM_CD                              AS "DM_CD"
                , A.COMP_NM                            AS "COMP_NM"
                , F_NVL_TEXT(RPAD(LEFT(DEBTOR_TEL, GREATEST(LENGTH(DEBTOR_TEL) - 5, 0)), LENGTH(DEBTOR_TEL), '*'), '모름')      AS "DEBTOR_TEL"
                , F_NVL_TEXT(A.DEBTOR_KAKAO, '모름')    AS "DEBTOR_KAKAO"
                , F_NVL_TEXT(A.DEBTOR_TELE, '모름')     AS "DEBTOR_TELE"
                , F_NVL_TEXT(A.DEBTOR_SNS, '모름')      AS "DEBTOR_SNS"
                , F_NVL_TEXT(A.WITHDR_LOCA, '모름')      AS "WITHDR_LOCA"
                , CASE WHEN CURRENT_DATE - TO_DATE(SUBSTRING(REPLACE(A.WRITE_DATE, '-', ''), 1, 8), 'YYYYMMDD') > F_NVL_NUM(B.SYSDEF_CD::INTEGER, 7) THEN 'N' ELSE 'Y' END AS "NEW_VALUE"
        FROM    PL_DM_M A
        LEFT JOIN (SELECT SYSDEF_CD FROM ES_CODEDTL WHERE FIELD_CD = 'ES_Q0141' AND FLAG1_CD = 'Y' LIMIT 1) B
            ON 1 = 1
        WHERE (
            A.COMP_NM LIKE SUBSTRING(#{COMP_NM}, 1, 2) || '%'
            OR  A.BORW_SITE LIKE '%' || SUBSTRING(#{BORW_SITE} FROM LENGTH(#{BORW_SITE}) - 4)
            OR  A.DEBTOR_TEL LIKE '%' || SUBSTRING(#{DEBTOR_TEL} FROM LENGTH(#{DEBTOR_TEL}) - 8)
            OR  A.DEBTOR_KAKAO LIKE '%' || SUBSTRING(#{DEBTOR_KAKAO} FROM LENGTH(#{DEBTOR_KAKAO}) - 4)
            OR  A.DEBTOR_TELE LIKE '%' || SUBSTRING(#{DEBTOR_TELE} FROM LENGTH(#{DEBTOR_TELE}) - 4)
            OR  A.DEBTOR_SNS LIKE '%' || SUBSTRING(#{DEBTOR_SNS} FROM LENGTH(#{DEBTOR_SNS}) - 4)
            OR  A.WITHDR_LOCA LIKE '%' || SUBSTRING(#{WITHDR_LOCA} FROM LENGTH(#{WITHDR_LOCA}) - 4)
        )
        LIMIT 3
    </select>

    <select id="randomList" resultType="hashmap" parameterType="hashmap">
        /*V2DmMapper.randomList*/
        SELECT    A.DM_CD                              AS "DM_CD"
                , A.COMP_NM                            AS "COMP_NM"
                , F_NVL_TEXT(A.DEBTOR_TEL, '모름')      AS "DEBTOR_TEL"
                , F_NVL_TEXT(A.DEBTOR_KAKAO, '모름')    AS "DEBTOR_KAKAO"
                , F_NVL_TEXT(A.DEBTOR_TELE, '모름')     AS "DEBTOR_TELE"
                , F_NVL_TEXT(A.DEBTOR_SNS, '모름')      AS "DEBTOR_SNS"
                , F_NVL_TEXT(A.WITHDR_LOCA, '모름')      AS "WITHDR_LOCA"
                , CASE WHEN CURRENT_DATE - TO_DATE(SUBSTRING(REPLACE(A.WRITE_DATE, '-', ''), 1, 8), 'YYYYMMDD') > F_NVL_NUM(B.SYSDEF_CD::INTEGER, 7) THEN 'N' ELSE 'Y' END AS "NEW_VALUE"
        FROM    PL_DM_M A
        LEFT JOIN (SELECT SYSDEF_CD FROM ES_CODEDTL WHERE FIELD_CD = 'ES_Q0141' AND FLAG1_CD = 'Y' LIMIT 1) B
            ON 1 = 1
        ORDER BY RANDOM()
        LIMIT 3
    </select>

    <select id="comments" resultType="hashmap" parameterType="hashmap">
        /*V2DmMapper.comments*/
        SELECT    A.DM_CD          AS "DM_CD"
                , A.COMM_CD        AS "COMM_CD"
                , A.PARENT_CD      AS "PARENT_CD"
                , CASE WHEN DELETE_YN = 'Y' THEN '' ELSE A.NICK_NM END AS "NICK_NM"
                , CASE WHEN DELETE_YN = 'Y' THEN A.DELETE_REMARK ELSE A.CONTENTS END AS "CONTENTS"
                , A.USE_YN         AS "USE_YN"
                , F_NVL_TEXT(A.DELETE_YN, 'N')		AS "DELETE_YN"
                , TO_CHAR(SUBSTRING(A.WRITE_DATE, 1, 8)::DATE, 'YYYY-MM-DD HH:DD')     AS "WRITE_DATE"
                , CASE WHEN
                    CURRENT_DATE - TO_DATE(SUBSTRING(REPLACE(A.WRITE_DATE, '-', ''), 1, 8), 'YYYYMMDD') > F_NVL_NUM(B.SYSDEF_CD::INTEGER, 7) THEN 'N'
                    ELSE 'Y'
                END AS "NEW_VALUE"
        FROM PL_DM_COMM A
        LEFT JOIN (SELECT SYSDEF_CD FROM ES_CODEDTL WHERE FIELD_CD = 'ES_Q0141' AND FLAG1_CD = 'Y' LIMIT 1) B
            ON 1 = 1
        WHERE DM_CD = #{DM_CD}
    </select>

	<insert id="createComment" parameterType="hashmap">
		/*V2DmMapper.createComment*/
		INSERT INTO PL_DM_COMM (
			  DM_CD
			, COMM_CD
			, PARENT_CD
			, NICK_NM
			, PASSWORD
			, CONTENTS
			, USE_YN
			, REPORT_YN
			, WRITE_DATE
			, WRITE_IP
			, INSERT_DATE
		)VALUES(
			  #{DM_CD}
			, #{COMM_CD}
			, #{PARENT_CD}
			, #{NICK_NM}
			, #{PASSWORD}
			, #{CONTENTS}
			, 'Y'
			, #{REPORT_YN}
			, #{WRITE_DATE}
			, #{WRITE_IP}
			, #{INSERT_DATE}
		)
	</insert>

    <update id="updateComment">
        /*V2DmMapper.updateComment*/
        UPDATE PL_DM_COMM
        SET CONTENTS   = #{CONTENTS}
          , UPDATE_DATE = #{UPDATE_DATE}
          , UPDATE_IP = #{UPDATE_IP}
        WHERE DM_CD = #{DM_CD}
        AND COMM_CD = #{COMM_CD}
    </update>

    <update id="deleteComment" parameterType="hashmap">
        /*V2DmMapper.deleteComment*/
        UPDATE  PL_DM_COMM
        SET   DELETE_YN = 'Y'
            , DELETE_REMARK = #{DELETE_REMARK}
        WHERE DM_CD = #{DM_CD}
        AND COMM_CD = #{COMM_CD}
    </update>

    <update id="deleteCommentAll" parameterType="hashmap">
        /*V2DmMapper.deleteCommentAll*/
        UPDATE  PL_DM_COMM
        SET   DELETE_YN = 'Y'
            , DELETE_REMARK = #{DELETE_REMARK}
        WHERE DM_CD = #{DM_CD}
    </update>

    <insert id="insertEsCommunityHit" parameterType="hashmap">
        /*V2DmMapper.insertEsCommunityHit*/
        INSERT INTO ES_COMMUNITY_HIT
        (COMPANY_CD, SEQ, IP)
        VALUES
        (#{COMPANY_CD}, #{DM_CD}, #{IP})
        ON CONFLICT (COMPANY_CD, SEQ, IP) DO NOTHING
    </insert>

    <update id="hitPlus" parameterType="hashmap">
        /*V2DmMapper.hitPlus*/
        UPDATE PL_DM_M
        SET   HIT = (SELECT COALESCE(HIT, 0) + 1 FROM PL_DM_M WHERE DM_CD = #{DM_CD})
        WHERE  DM_CD = #{DM_CD}
    </update>

    <select id="checkCommentPassword" resultType="string">
        /*V2DmMapper.checkCommentPassword*/
        SELECT PASSWORD
        FROM PL_DM_COMM
        WHERE DM_CD = #{DM_CD}
        AND COMM_CD = #{COMM_CD}
    </select>
</mapper>