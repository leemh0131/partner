<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ensys.qray.web.v2.dm.V2DmMapper">

    <select id="listCount" resultType="int" parameterType="hashmap">
        /*V2DmMapper.listCount*/
        SELECT COUNT(*)
        FROM PL_DM_COMM
    </select>

    <select id="list" resultType="hashmap" parameterType="hashmap">
        /*V2DmMapper.list*/
        SELECT    DM_CD AS "SEQ"
                , F_NVL_TEXT(SUBSTRING(DM_CONTENTS, 1, 50), COMP_NM) AS "TITLE"
                , ROW_NUMBER() OVER (ORDER BY INSERT_DATE) AS "COMM_NUM"
                , SUBSTRING(COMP_NM, 1, 1) || 'OO' AS "NAME"
                , TO_CHAR(SUBSTRING(INSERT_DATE, 1, 8)::DATE, 'YYYY-MM-DD HH:DD') AS "DTS"
                , (SELECT COUNT(*) FROM PL_DM_COMM WHERE DM_CD = A.DM_CD) AS "COMM_CUT"
                , CASE WHEN coalesce(HIT, 0) BETWEEN 0 AND 999 THEN coalesce(HIT, 0)::VARCHAR ELSE '999â†‘' END AS "HIT"
                , CASE WHEN CURRENT_DATE - TO_DATE(SUBSTRING(REPLACE(INSERT_DATE, '-', ''), 1, 8), 'YYYYMMDD') > F_NVL_NUM(B.SYSDEF_CD::INTEGER, 7) THEN 'N' ELSE 'Y' END AS "NEW_VALUE"
        FROM PL_DM_M A
        LEFT JOIN (SELECT SYSDEF_CD FROM ES_CODEDTL WHERE FIELD_CD = 'ES_Q0141' AND FLAG1_CD = 'Y' LIMIT 1) B
            ON 1 = 1
        ORDER BY INSERT_DATE DESC
        LIMIT 15 OFFSET (#{CURRENT_PAGE}::INTEGER - 1) * 15
    </select>

    <insert id="create" parameterType="hashmap">
        /*V2DmMapper.create*/
        INSERT INTO PL_DM_M (
              DM_CD
            , DM_TYPE
            , DM_KIND
            , COMP_NM
            , BORW_SITE
            , DEBTOR_TEL
            , DEBTOR_KAKAO
            , DEBTOR_TELE
            , DEBTOR_SNS
            , WITHDR_LOCA
            , COMPL_POLICE
            , DM_CONTENTS
            , PW
            , USE_YN
            , WRITE_DATE
            , WRITE_IP
            , INSERT_DATE
            , UPDATE_DATE
        ) VALUES (
              #{DM_CD}
            , #{DM_TYPE}
            , #{DM_KIND}
            , #{COMP_NM}
            , #{BORW_SITE}
            , #{DEBTOR_TEL}
            , #{DEBTOR_KAKAO}
            , #{DEBTOR_TELE}
            , #{DEBTOR_SNS}
            , #{WITHDR_LOCA_ARR}
            , #{COMPL_POLICE}
            , #{DM_CONTENTS}
            , #{PW}
            , 'Y'
            , #{WRITE_DATE}
            , #{WRITE_IP}
            , #{INSERT_DATE}
            , #{UPDATE_DATE}
        )
    </insert>

    <insert id="createDeposit" parameterType="hashmap">
        /*V2DmMapper.createDeposit*/
        <if test="BANK_CD_ARR != null and BANK_CD_ARR != ''">
            <foreach item="bankCd" index="index" collection='BANK_CD_ARR.split("\\|")' separator=";">
                INSERT INTO PL_DM_DEPOSIT (
                      DM_CD
                    , SEQ
                    , BANK_CD
                    , NO_DEPOSIT
                    , NM_DEPOSITOR
                    , USE_YN
                    , INSERT_DATE
                    , UPDATE_DATE
                ) VALUES (
                      #{DM_CD}
                    , #{index} + 1
                    , SPLIT_PART(#{BANK_CD_ARR}, '|', #{index} + 1) -- BANK_CD
                    , SPLIT_PART(#{NO_DEPOSIT_ARR}, '|', #{index} + 1) -- NO_DEPOSIT
                    , SPLIT_PART(#{NM_DEPOSITOR_ARR}, '|', #{index} + 1) -- NM_DEPOSITOR
                    , 'Y'
                    , #{INSERT_DATE}
                    , #{UPDATE_DATE}
                )
            </foreach>
        </if>
    </insert>
</mapper>