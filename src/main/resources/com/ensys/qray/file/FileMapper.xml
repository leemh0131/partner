<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ensys.qray.file.FileMapper">

    <select id="search" resultType="hashmap" parameterType="hashmap" statementType="CALLABLE">
		/*FileMapper.search*/
    	SELECT 	COMPANY_CD		AS "COMPANY_CD"
		,		TABLE_ID        AS "TABLE_ID"
		,		TABLE_KEY       AS "TABLE_KEY"
		,		FILE_SEQ        AS "FILE_SEQ"
		,		FILE_NAME       AS "FILE_NAME"
		,		ORGN_FILE_NAME  AS "ORGN_FILE_NAME"
		,		FILE_PATH       AS "FILE_PATH"
		,		FILE_EXT        AS "FILE_EXT"
		,		FILE_BYTE       AS "FILE_BYTE"
		,		FILE_SIZE       AS "FILE_SIZE"
		,		FILE_DIVISION   AS "FILE_DIVISION"
		,		MAIN_YN   		AS "MAIN_YN"
		,		INSERT_ID       AS "INSERT_ID"
		,		INSERT_DTS      AS "INSERT_DTS"
		,		UPDATE_ID       AS "UPDATE_ID"
		,		UPDATE_DTS      AS "UPDATE_DTS"
		FROM ES_FILE
		WHERE COMPANY_CD = #{COMPANY_CD}
		AND   TABLE_ID   = #{TABLE_ID}
		<if test='FILE_SEQ != null and FILE_SEQ != ""'>
		AND   TABLE_KEY  = #{TABLE_KEY}
		</if>
		<if test='FILE_SEQ != null and FILE_SEQ != ""'>
		AND   FILE_SEQ   = #{FILE_SEQ}
		</if>
		<if test='FILE_NAME != null and KEYWORD != ""'>
		AND   FILE_NAME  = #{FILE_NAME}
		</if>
    </select>

    <insert id="insert" parameterType="hashmap" statementType="CALLABLE">
		/*FileMapper.insert*/
		INSERT INTO ES_FILE
		(
		  COMPANY_CD    
		, TABLE_ID      
		, TABLE_KEY     
		, FILE_SEQ      
		, FILE_NAME     
		, ORGN_FILE_NAME
		, FILE_PATH     
		, FILE_EXT      
		, FILE_BYTE     
		, FILE_SIZE
		, FILE_DIVISION     
		, MAIN_YN
		, INSERT_ID
		, INSERT_DTS    
		, UPDATE_ID     
		, UPDATE_DTS
		, LINK
		, REMARK
		)
		VALUES
		(
		  #{COMPANY_CD}    
		, #{TABLE_ID}      
		, #{TABLE_KEY}     
		, #{FILE_SEQ}      
		, #{FILE_NAME}     
		, #{ORGN_FILE_NAME}
		, #{FILE_PATH}     
		, #{FILE_EXT}      
		, #{FILE_BYTE}     
		, #{FILE_SIZE} 
		, #{FILE_DIVISION}   
		, #{MAIN_YN}
		, #{INSERT_ID}
		, #{INSERT_DTS}    
		, #{UPDATE_ID}     
		, #{UPDATE_DTS}
		, #{LINK}
		, #{REMARK}
		)
    </insert>

	<insert id="upsert" parameterType="hashmap">
		/*FileMapper.upsert (UPSERT)*/
		INSERT INTO ES_FILE
		(
		  COMPANY_CD
		, TABLE_ID
		, TABLE_KEY
		, FILE_SEQ
		, FILE_NAME
		, ORGN_FILE_NAME
		, FILE_PATH
		, FILE_EXT
		, FILE_BYTE
		, FILE_SIZE
		, FILE_DIVISION
		, MAIN_YN
		, INSERT_ID
		, INSERT_DTS
		, UPDATE_ID
		, UPDATE_DTS
		, LINK
		, REMARK
		)
		VALUES
		(
		  #{COMPANY_CD}
		, #{TABLE_ID}
		, #{TABLE_KEY}
		, COALESCE(
			NULLIF(#{FILE_SEQ}, '')::NUMERIC,
			(SELECT COALESCE(MAX(FILE_SEQ::INTEGER), 0) + 1
			 FROM ES_FILE
			 WHERE COMPANY_CD = #{COMPANY_CD}
			   AND TABLE_ID = #{TABLE_ID}
			   AND TABLE_KEY = #{TABLE_KEY})
		  )
		, #{FILE_NAME}
		, #{ORGN_FILE_NAME}
		, #{FILE_PATH}
		, #{FILE_EXT}
		, #{FILE_BYTE}
		, #{FILE_SIZE}
		, #{FILE_DIVISION}
		, #{MAIN_YN}
		, #{INSERT_ID}
		, #{INSERT_DTS}
		, #{UPDATE_ID}
		, #{UPDATE_DTS}
		, #{LINK}
		, #{REMARK}
		)
		ON CONFLICT (COMPANY_CD, TABLE_ID, TABLE_KEY, FILE_SEQ)
		DO UPDATE SET
		  FILE_NAME      = EXCLUDED.FILE_NAME
		, ORGN_FILE_NAME = EXCLUDED.ORGN_FILE_NAME
		, FILE_PATH      = EXCLUDED.FILE_PATH
		, FILE_EXT       = EXCLUDED.FILE_EXT
		, FILE_BYTE      = EXCLUDED.FILE_BYTE
		, FILE_SIZE      = EXCLUDED.FILE_SIZE
		, FILE_DIVISION  = EXCLUDED.FILE_DIVISION
		, MAIN_YN        = EXCLUDED.MAIN_YN
		, UPDATE_ID      = EXCLUDED.UPDATE_ID
		, UPDATE_DTS     = EXCLUDED.UPDATE_DTS
		, LINK           = EXCLUDED.LINK
		, REMARK         = EXCLUDED.REMARK
		</insert>

    <delete id="delete" parameterType="hashmap" statementType="CALLABLE">
		/*FileMapper.delete*/
		DELETE FROM ES_FILE
		WHERE COMPANY_CD = #{COMPANY_CD}
		AND   TABLE_ID   = #{TABLE_ID}
		AND   TABLE_KEY  = cast(#{TABLE_KEY} as text)
		AND   FILE_SEQ   = #{FILE_SEQ}
    </delete>

	<update id="updated" parameterType="hashmap" statementType="CALLABLE">
		/*FileMapper.updated*/
		update ES_FILE
		SET MAIN_YN      =   #{MAIN_YN}
		  ,	UPDATE_ID 	 =   #{UPDATE_ID}
		  ,	UPDATE_DTS 	 =   #{UPDATE_DTS}
		WHERE COMPANY_CD = #{COMPANY_CD}
		  AND   TABLE_ID   = #{TABLE_ID}
		  AND   FILE_SEQ   = #{FILE_SEQ}
		  AND   TABLE_KEY  = cast(#{TABLE_KEY} as text)
		  AND   FILE_SEQ   = #{FILE_SEQ}
	</update>

</mapper>